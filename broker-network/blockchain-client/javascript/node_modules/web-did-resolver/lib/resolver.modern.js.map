{"version":3,"file":"resolver.modern.js","sources":["../src/resolver.ts"],"sourcesContent":["import fetch from 'cross-fetch'\nimport { DIDDocument, DIDResolutionResult, DIDResolver, ParsedDID } from 'did-resolver'\n\nconst DOC_PATH = '/.well-known/did.json'\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function get(url: string): Promise<any> {\n  const res = await fetch(url, { mode: 'cors' })\n  if (res.status >= 400) {\n    throw new Error(`Bad response ${res.statusText}`)\n  }\n  return res.json()\n}\n\nexport function getResolver(): Record<string, DIDResolver> {\n  async function resolve(did: string, parsed: ParsedDID): Promise<DIDResolutionResult> {\n    let err = null\n    let path = decodeURIComponent(parsed.id) + DOC_PATH\n    const id = parsed.id.split(':')\n    if (id.length > 1) {\n      path = id.map(decodeURIComponent).join('/') + '/did.json'\n    }\n\n    const url = `https://${path}`\n\n    const didDocumentMetadata = {}\n    let didDocument: DIDDocument | null = null\n\n    do {\n      try {\n        didDocument = await get(url)\n      } catch (error) {\n        err = `resolver_error: DID must resolve to a valid https URL containing a JSON document: ${error}`\n        break\n      }\n\n      // TODO: this excludes the use of query params\n      const docIdMatchesDid = didDocument?.id === did\n      if (!docIdMatchesDid) {\n        err = 'resolver_error: DID document id does not match requested did'\n        // break // uncomment this when adding more checks\n      }\n      // eslint-disable-next-line no-constant-condition\n    } while (false)\n\n    const contentType =\n      typeof didDocument?.['@context'] !== 'undefined' ? 'application/did+ld+json' : 'application/did+json'\n\n    if (err) {\n      return {\n        didDocument,\n        didDocumentMetadata,\n        didResolutionMetadata: {\n          error: 'notFound',\n          message: err,\n        },\n      }\n    } else {\n      return {\n        didDocument,\n        didDocumentMetadata,\n        didResolutionMetadata: { contentType },\n      }\n    }\n  }\n\n  return { web: resolve }\n}\n"],"names":["DOC_PATH","get","url","res","fetch","mode","status","Error","statusText","json","getResolver","resolve","did","parsed","err","path","decodeURIComponent","id","split","length","map","join","didDocumentMetadata","didDocument","error","docIdMatchesDid","contentType","didResolutionMetadata","message","web"],"mappings":";;AAGA,MAAMA,QAAQ,GAAG,uBAAjB;;AAGA,eAAeC,GAAf,CAAmBC,GAAnB,EAA8B;AAC5B,EAAA,MAAMC,GAAG,GAAG,MAAMC,KAAK,CAACF,GAAD,EAAM;AAAEG,IAAAA,IAAI,EAAE,MAAA;AAAR,GAAN,CAAvB,CAAA;;AACA,EAAA,IAAIF,GAAG,CAACG,MAAJ,IAAc,GAAlB,EAAuB;IACrB,MAAM,IAAIC,KAAJ,CAAU,CAAA,aAAA,EAAgBJ,GAAG,CAACK,UAAY,EAA1C,CAAN,CAAA;AACD,GAAA;;EACD,OAAOL,GAAG,CAACM,IAAJ,EAAP,CAAA;AACD,CAAA;;SAEeC,cAAW;AACzB,EAAA,eAAeC,OAAf,CAAuBC,GAAvB,EAAoCC,MAApC,EAAqD;AAAA,IAAA,IAAA,aAAA,CAAA;;IACnD,IAAIC,GAAG,GAAG,IAAV,CAAA;IACA,IAAIC,IAAI,GAAGC,kBAAkB,CAACH,MAAM,CAACI,EAAR,CAAlB,GAAgCjB,QAA3C,CAAA;IACA,MAAMiB,EAAE,GAAGJ,MAAM,CAACI,EAAP,CAAUC,KAAV,CAAgB,GAAhB,CAAX,CAAA;;AACA,IAAA,IAAID,EAAE,CAACE,MAAH,GAAY,CAAhB,EAAmB;MACjBJ,IAAI,GAAGE,EAAE,CAACG,GAAH,CAAOJ,kBAAP,CAAA,CAA2BK,IAA3B,CAAgC,GAAhC,CAAA,GAAuC,WAA9C,CAAA;AACD,KAAA;;AAED,IAAA,MAAMnB,GAAG,GAAc,CAAAa,QAAAA,EAAAA,KAAvB,CAAA,CAAA;IAEA,MAAMO,mBAAmB,GAAG,EAA5B,CAAA;IACA,IAAIC,WAAW,GAAuB,IAAtC,CAAA;;IAEA,GAAG;AAAA,MAAA,IAAA,YAAA,CAAA;;MACD,IAAI;AACFA,QAAAA,WAAW,GAAG,MAAMtB,GAAG,CAACC,GAAD,CAAvB,CAAA;OADF,CAEE,OAAOsB,KAAP,EAAc;QACdV,GAAG,GAAG,CAAqFU,kFAAAA,EAAAA,KAAK,CAAhG,CAAA,CAAA;AACA,QAAA,MAAA;AACD,OANA;;;MASD,MAAMC,eAAe,GAAG,CAAAF,CAAAA,YAAAA,GAAAA,WAAW,SAAX,GAAaN,KAAAA,CAAAA,GAAAA,YAAAA,CAAAA,EAAb,MAAoBL,GAA5C,CAAA;;MACA,IAAI,CAACa,eAAL,EAAsB;QACpBX,GAAG,GAAG,8DAAN,CADoB;AAGrB,OAbA;;AAeF,KAfD,QAeS,KAfT,EAAA;;AAiBA,IAAA,MAAMY,WAAW,GACf,QAAOH,CAAAA,aAAAA,GAAAA,WAAP,KAAO,IAAA,GAAA,KAAA,CAAA,GAAA,aAAA,CAAc,UAAd,CAAP,CAAqC,KAAA,WAArC,GAAmD,yBAAnD,GAA+E,sBADjF,CAAA;;AAGA,IAAA,IAAIT,GAAJ,EAAS;MACP,OAAO;QACLS,WADK;QAELD,mBAFK;AAGLK,QAAAA,qBAAqB,EAAE;AACrBH,UAAAA,KAAK,EAAE,UADc;AAErBI,UAAAA,OAAO,EAAEd,GAAAA;AAFY,SAAA;OAHzB,CAAA;AAQD,KATD,MASO;MACL,OAAO;QACLS,WADK;QAELD,mBAFK;AAGLK,QAAAA,qBAAqB,EAAE;AAAED,UAAAA,WAAAA;AAAF,SAAA;OAHzB,CAAA;AAKD,KAAA;AACF,GAAA;;EAED,OAAO;AAAEG,IAAAA,GAAG,EAAElB,OAAAA;GAAd,CAAA;AACD;;;;"}